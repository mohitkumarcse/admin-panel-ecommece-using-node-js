<h2 class="mb-4">Welcome, <%= username %></h2>

<div class="mb-3 text-end">
  <% if (role == 1) { %>
  <a href="/admin/category/create">
    <button class="btn btn-sm btn-dark">Create category</button>
  </a>
  <% } %>
</div>

<div class="table-responsive">
  <div id="user-table"></div>
</div>

<script>
  let table;
  document.addEventListener("DOMContentLoaded", function () {
    const categories = <%- JSON.stringify(categories) %>;
    const userRole = <%= role %>;
    table = new Tabulator("#user-table", {
      index: "_id",
      data: categories,
      layout: "fitColumns",
      reactiveLayout: true,
      pagination: "local",
      paginationSize: 10,
      paginationSizeSelector: [3, 5, 10, 20],
      columns: [
        {
          title: "#",
          field: "id",
          width: 50,
          sorter: "number",
          headerFilter: "input",
        },
        {
          title: "Category Image",
          field: "categoryimage",
          formatter: function(cell) {
            console.log(cell.getRow().getData())
            const image = cell.getRow().getData().categoryimage || 'profile.png';
            return `<img src="/uploads/${image}" alt="Category Image" width="50" height="50" class="rounded-circle">`;
          },
        },
        {
          title: "Name",
          field: "name",
          sorter: "string",
          headerFilter: "input",
        },
        {
          title: "Description",
          field: "description",
          sorter: "string",
          headerFilter: "input",
        },
        {
          title:'Parent',
          field:'parent',
          sorter:'string',
          headerFilter:'select',
        },
        {
          title: "Home Trending",
          field: "isHomeTrending",
          headerFilter: "select",
          headerFilterParams: {
            values: {
              "": "-- Select Status --",
              1: "Active",
              2: "Inactive"
            },
          },
         formatter: function (cell) {
            const data = cell.getRow().getData();
            const checked = data.isHomeTrending === true ? 'checked' : '';
            return `
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" ${checked} onclick="changeStatus('${data._id}','is_home_trending')">
              </div>
            `;
          }
        },
        {
          title: "Women Trending",
          field: "isWomenTrending",
          headerFilter: "select",
          headerFilterParams: {
            values: {
              "": "-- Select Status --",
              1: "Active",
              2: "Inactive"
            },
          },
          formatter: function (cell) {
            const data = cell.getRow().getData();
            const checked = data.isWomenTrending === true ? 'checked' : '';
            return `
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" ${checked} onclick="changeStatus('${data._id}','is_women_trending')">
              </div>
            `;
          }
        },
        {
          title: "Men Trending",
          field: "isMenTrending",
          headerFilter: "select",
          headerFilterParams: {
            values: {
              "": "-- Select Status --",
              1: "Active",
              2: "Inactive"
            },
          },
          formatter: function (cell) {
            const data = cell.getRow().getData();
            const checked = data.isMenTrending === true ? 'checked' : '';
            return `
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" ${checked} onclick="changeStatus('${data._id}','is_men_trending')">
              </div>
            `;
          },
        },
        {
          title: "Status",
          field: "status",
          headerFilter: "select",
          headerFilterParams: {
            values: {
              "": "-- Select Status --",
              1: "Active",
              0: "Inactive",
            },
          },
          formatter: function (cell) {
            const data = cell.getRow().getData();
            const checked = data.status === 'active' ? 'checked' : '';
            return `
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" ${checked} onclick="changeStatus('${data._id}','status')">
              </div>
            `;
          }
        },
        {
          title: "Actions",
          field: "actions",
          hozAlign: "center",
          width: 300,
          headerSort: false,
          formatter: function(cell) {
            const id = cell.getRow().getData()._id;
            if (userRole == 1) {
              return `
                <a href="/admin/category/view/${id}">
                  <button class='btn btn-sm btn-primary me-1'>View</button>
                </a>
                <a href="/admin/category/edit/${id}">
                  <button class='btn btn-sm btn-success me-1'>Edit</button>
                </a>
                <a href="/admin/category/delete/${id}" onclick="return confirm('Are you sure you want to delete this category?')">
                  <button class='btn btn-sm btn-danger'>Delete</button>
                </a>
              `;
            }
            return '';
          }
        },
      ],
    });
  });

  async function changeStatus(id,type) {
    try {
      const res = await fetch(`/admin/category/update-status/${id}/${type}`);
      const data = await res.json();
      console.log(data)
      if (data.success) {
        table.updateData([{ _id: id, status: data.status }]);
      } else {
        alert(data.message || "Failed to update status.");
      }
    } catch (err) {
      console.error(err);
      alert("Error updating status.");
    }
  }
</script>
